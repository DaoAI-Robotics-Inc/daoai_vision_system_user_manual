设置抓取策略
==================

本章会详细介绍如何设置抓取策略。所有抓取任务的设置抓取策略流程都是一样的。

    .. image:: images/Pick_intro.png
        :scale: 100%

|

抓取策略决定了机器人该如何抓取物体。设置流程包括以下4步：

.. contents::
    :local:


1. 设置夹爪模型
-------------------------------------

    1. 选择一个夹爪模型，然后点击保存夹爪模型。该模型只用于显示目的。

        .. image:: images/select_tcp.png
            :scale: 60%

|

    2. 点击定义夹爪中心点，然后点击显示按钮。这是可以看到坐标的输入框，输入TCP的坐标和旋转来定义；也可以在显示窗口上拖动来定义， 然后点击保存即可。


        .. image:: images/define_tcp1.png
            :scale: 60%

|

.. note::
    实际使用时，建议用机器人建立TCP（tool center point）后，从机器人处将TCP位置输入进这一步，之后机器人改用法兰的位置(0,0,0)进行交互。
        .. image:: images/ur_tcp.png
            :scale: 60%


2. 设置TCP与物体的相对关系
-----------------------------

这一步是为了记录夹爪抓取物体时的标准相对位置关系，这一步也被称为示教。

虚拟示教
~~~~~~~~~
    
    虚拟示教是由用户手动输入TCP 到 物体的相对关系变换。

    1. 首先从左边的标签列来选择一个要示教的物体标签。
    
    2. 点击 ``+`` 添加一个抓取姿势， 然后手动输入TCP和物体的相对关系。

    3. 以下图为例，x,y 为0， z 为10mm， rx 为180°。那么在抓取时，抓取位置就是TCP在物体以参照点为基准的正上方10mm处。
    
    .. tip::
        由于夹爪定义时z轴是向上的，抓取时通常是从上往下抓（z轴朝下），而物体的z轴朝上，通常虚拟示教需要有一个 rx 或者 ry 的180°旋转。 

    .. image:: images/virtual_teach_pose.png
        :scale: 70%

    **同一个物体使用多个示教时，如果有其中一个抓取点位无法达到，例如被箱体挡住，则会使用其它可以达到的示教关系。**


真实示教
~~~~~~~~~

    真实示教是由用户移动机器人至标准的抓取姿态，然后发送该位姿至机器人视觉认知系统，由机器人视觉认知系统计算并记录TCP和物体的相对关系。

    以UR为例
    
    1. 首先从左边的标签列来选择一个要示教的物体标签。

    
    2. 点击 ``+`` 添加一个抓取姿势。

    .. warning::
        1. 需要确保场景中只有一个物体，因为如果有多个物体，则无法判断是以两个中的哪个来示教。
        2. 示教过程中不可以移动物体，如果物体不小心移动了，则需要重新拍照定位进行示教。

    3. 来到UR面板，切换到发送位姿脚本。
    4. 确认ip和port和机器人视觉认知系统设置的一致。
    5. 移动机器人至标准抓取姿态。并设置current pose为该姿态。
    6. 调用daoai_teach_pose()函数，运行机器人脚本，发送位姿。

        .. image:: images/ur_teach_pose.png
            :scale: 70%
    
    7. 回到网页，点击获取姿势，成功后，夹爪和物体的抓取位置关系会在右边的显示窗口中显示出来。点击保存此位姿即可。

        .. image:: images/teach_pose_example_1.png
            :scale: 70%

    8. 点击保存来保存这个抓取关系。

    .. tip::
        在真实示教后，仍然可以切换到虚拟示教来查看、微调所记录的TCP和物体的相对位置关系。

    **同一个物体使用多个示教时，如果有其中一个抓取点位无法达到，例如被箱体挡住，则会使用其它可以达到的示教关系。**

灵活位姿抓取（可选）
~~~~~~~~~~~~~~~~~~~

在示教完成后，可以按照需要启用灵活抓取位姿。灵活抓取位姿主要提供了2种灵活抓取策略：优先从上方抓取，优先以最小的倾斜抓取。

    .. image:: images/teach_pose_example_1.png
        :scale: 70%

**优先从上方抓取：** 当物体产生倾斜时，以参考系（定义ROI时箱体工具的坐标轴）的z轴为上方，优先从上方抓取。

    .. image:: images/pick_from_top.png
        :scale: 70%


**优先以最小的倾斜抓取：** 当物体产生倾斜时，以定义的标准抓取姿态为准，优先从定义的标准抓取位姿进行抓取。

    .. image:: images/pick_with_less_tilt.png
        :scale: 70%

1. 启用夹爪：灵活抓取位姿。

2. 设置夹爪中心对称原点，在倾斜、旋转夹爪时，会以这个点为基准旋转。

3. 勾选显示灵活度，可以在显示窗口下方拖动灵活度预览，查看允许旋转的最大角度。

    .. image:: images/flexibility_preview.png
        :scale: 70%


4. 允许z轴倾斜： 是否允许夹爪倾斜抓取。

5. 相对倾斜轴：允许夹爪在哪个轴上进行旋转

6. 倾斜角度：允许夹爪和物体以标准抓取位姿为基准的最大倾斜角度，推荐不大于20°。

7. 旋转抓取策略： 优先从上方抓取 或者 优先以最小倾斜抓取

8. z轴可旋转：选择1， 360度，180度，不允许z轴旋转。

9. 全部设置完成后，点击保存此位姿完成设置。


3. 设置防碰撞
------------------------

防碰撞设置限制了机器人夹爪可以抓取的最大倾斜角度，以及限制了夹爪位置生成，使其不会生成在与箱体发生碰撞的位置上。

    .. image:: images/collision_avoidance.png
        :scale: 70%


1. 防碰撞默认使用了30度的最大机器人倾斜角度，您也可以更改这个限制使其符合您的需求。（如果角度大于等于180度，则等同于关闭最大倾斜限制）

.. note::
    这里的最大倾斜角度，是以定义场景ROI时同时定义的参考系（箱体坐标）的z轴为基准。任何倾斜角度大于设定的角度的抓取位姿都会被过滤掉。

2. 点击使用箱体定义操作空间，来定义一个虚拟箱体，任何会与虚拟箱体位置碰撞的抓取位姿都不会被生成。

    .. image:: images/virtual_bin.png
        :scale: 70%

.. warning::
    显示窗口中定义虚拟箱体的ROI工具不会同时定义参考系，只有检测流程里的定义场景ROI工具会定义参考系。


4. 设置抓取顺序
----------------------

抓取顺序决定了物体该以何种顺序被抓起。在这个步骤里还可以设置是否对齐物体的旋转。

.. tip::
    例如，圆形的物体，通常旋转不会造成物体的改变，我们就会通过对齐物体的旋转角度，使机器人在抓取时不会有z轴的旋转，从而节约机器人操作。



    .. image:: images/pick_sort.png
        :scale: 70%

1. 设置抓取顺序。

    .. image:: images/sort_order.png
        :scale: 70%

例，z值最高，也就是机器人会优先从最上面的物体抓。
    x值最高，（定义参考系时，x轴时指向右侧），也就是机器人会从右到左抓。

.. note::
    这里的物体的x,y,z值是以参考系为基准的，参考系是在检测流程里的 定义场景ROI完成的。

2. 设置物体位姿的xy轴对齐： 

    .. image:: images/align_pose.png
        :scale: 70%

    .. image:: images/order_eg.png
        :scale: 70%

3. 设置物体的z轴对齐:
    正：确保物体的z轴朝上，如果检测匹配到了z轴朝下的物体，则使物体的z轴颠倒，从而朝向上方。
    负：确保物体的z轴朝下，如果检测匹配到了z轴朝上的物体，则使物体的z轴颠倒，从而朝向下方。


4. 使用层过滤：
    启用后，可以设置层间距（mm），会过滤掉以最上方的物体位姿为基准，向下多少mm以外的物体坐标。也就是只保留最上面一层的物体坐标。

.. tips::
    如果您有堆叠摆放的物体，需要每次抓取一层，然后每层从右往左抓。您可以设置使用层过滤，然后使用抓取顺序：X值最高。这样就可以分层+顺序抓取。


探测和抓取全部设置完成后，您的任务就准备好进行部署了。请参考 :ref:`任务部署` 